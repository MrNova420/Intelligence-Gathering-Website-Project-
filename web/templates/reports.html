{% extends "base.html" %}
{% block title %}Reports & Analytics - Intelligence Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="d-flex align-items-center mb-2">
            <i class="fas fa-chart-bar me-3 text-primary"></i>
            Reports & Analytics
        </h1>
        <p class="text-muted">Generate comprehensive intelligence reports and analytics from your scan data</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="generateReport()">
                <i class="fas fa-plus me-2"></i>New Report
            </button>
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportReports('pdf')">PDF Report</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportReports('excel')">Excel Spreadsheet</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportReports('json')">JSON Data</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-file-alt fa-2x text-success"></i>
                </div>
                <h4 class="mb-1">47</h4>
                <p class="text-muted mb-0">Total Reports</p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-search fa-2x text-info"></i>
                </div>
                <h4 class="mb-1">156</h4>
                <p class="text-muted mb-0">Scans Analyzed</p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-chart-line fa-2x text-warning"></i>
                </div>
                <h4 class="mb-1">89%</h4>
                <p class="text-muted mb-0">Success Rate</p>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-clock fa-2x text-primary"></i>
                </div>
                <h4 class="mb-1">2.3s</h4>
                <p class="text-muted mb-0">Avg Duration</p>
            </div>
        </div>
    </div>
</div>

<!-- Report Filters and Search -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form class="row g-3" id="reportFilters">
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" name="date_range">
                            <option value="7d">Last 7 days</option>
                            <option value="30d" selected>Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                            <option value="1y">Last year</option>
                            <option value="custom">Custom range</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" name="report_type">
                            <option value="all">All Reports</option>
                            <option value="email">Email Intelligence</option>
                            <option value="phone">Phone Analysis</option>
                            <option value="domain">Domain Reports</option>
                            <option value="social">Social Media</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="all">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="processing">Processing</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search reports..." name="search">
                            <button class="btn btn-outline-secondary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reports Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Reports</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-view="table">
                        <i class="fas fa-table"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-view="grid">
                        <i class="fas fa-th"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="reportsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0">Report</th>
                                <th class="border-0">Type</th>
                                <th class="border-0">Target</th>
                                <th class="border-0">Status</th>
                                <th class="border-0">Created</th>
                                <th class="border-0">Size</th>
                                <th class="border-0">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Dynamic content will be loaded here -->
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        <div>
                                            <div class="fw-semibold">Comprehensive Analysis Report</div>
                                            <small class="text-muted">ID: RPT-2024-001</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-primary-subtle text-primary">Email Intelligence</span></td>
                                <td class="font-monospace">target@example.com</td>
                                <td><span class="badge bg-success">Completed</span></td>
                                <td>
                                    <div>Jan 15, 2024</div>
                                    <small class="text-muted">2:30 PM</small>
                                </td>
                                <td>2.3 MB</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewReport('RPT-2024-001')" title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="downloadReport('RPT-2024-001')" title="Download">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="shareReport('RPT-2024-001')" title="Share">
                                            <i class="fas fa-share"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteReport('RPT-2024-001')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                        <div>
                                            <div class="fw-semibold">Domain Analysis Summary</div>
                                            <small class="text-muted">ID: RPT-2024-002</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-info-subtle text-info">Domain Analysis</span></td>
                                <td class="font-monospace">example.com</td>
                                <td><span class="badge bg-warning">Processing</span></td>
                                <td>
                                    <div>Jan 16, 2024</div>
                                    <small class="text-muted">9:15 AM</small>
                                </td>
                                <td>-</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" disabled title="Processing">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center p-3">
                    <div class="text-muted">
                        Showing 1-10 of 47 reports
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportGenerationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>Generate New Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportGenerationForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Report Name</label>
                            <input type="text" class="form-control" name="report_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" name="report_type" required>
                                <option value="">Select type...</option>
                                <option value="comprehensive">Comprehensive Analysis</option>
                                <option value="summary">Executive Summary</option>
                                <option value="technical">Technical Report</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Source</label>
                            <select class="form-select" name="data_source" required>
                                <option value="">Select source...</option>
                                <option value="recent_scans">Recent Scans (30 days)</option>
                                <option value="all_scans">All Scans</option>
                                <option value="specific_scan">Specific Scan ID</option>
                                <option value="date_range">Custom Date Range</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Output Format</label>
                            <select class="form-select" name="output_format" required>
                                <option value="pdf">PDF Document</option>
                                <option value="html">HTML Report</option>
                                <option value="json">JSON Data</option>
                                <option value="csv">CSV Export</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Include Sections</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="executive_summary" checked>
                                    <label class="form-check-label">Executive Summary</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="scan_results" checked>
                                    <label class="form-check-label">Scan Results</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="risk_analysis" checked>
                                    <label class="form-check-label">Risk Analysis</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="recommendations">
                                    <label class="form-check-label">Recommendations</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="technical_details">
                                    <label class="form-check-label">Technical Details</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="sections" value="appendices">
                                    <label class="form-check-label">Appendices</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Any additional notes or requirements for the report..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReportGeneration()">
                    <i class="fas fa-cog me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Report management functions
function generateReport() {
    const modal = new bootstrap.Modal(document.getElementById('reportGenerationModal'));
    modal.show();
}

function submitReportGeneration() {
    const form = document.getElementById('reportGenerationForm');
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    submitBtn.disabled = true;
    
    // Simulate report generation
    setTimeout(() => {
        showAlert('success', 'Report generation started! You will be notified when it\'s ready.');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('reportGenerationModal'));
        modal.hide();
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Reset form
        form.reset();
        
        // Add new row to table (simulate)
        addNewReportRow({
            id: 'RPT-' + Date.now(),
            name: formData.get('report_name'),
            type: formData.get('report_type'),
            status: 'processing'
        });
    }, 2000);
}

function addNewReportRow(report) {
    const tbody = document.getElementById('reportsTableBody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <i class="fas fa-file-alt text-info me-2"></i>
                <div>
                    <div class="fw-semibold">${report.name}</div>
                    <small class="text-muted">ID: ${report.id}</small>
                </div>
            </div>
        </td>
        <td><span class="badge bg-info-subtle text-info">${report.type}</span></td>
        <td>-</td>
        <td><span class="badge bg-warning">Processing</span></td>
        <td>
            <div>Just now</div>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </td>
        <td>-</td>
        <td>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" disabled title="Processing">
                    <i class="fas fa-spinner fa-spin"></i>
                </button>
            </div>
        </td>
    `;
    tbody.insertBefore(row, tbody.firstChild);
}

function viewReport(reportId) {
    window.open(`/reports/${reportId}`, '_blank');
}

function downloadReport(reportId) {
    showAlert('info', `Downloading report ${reportId}...`);
    // Simulate download
    setTimeout(() => {
        showAlert('success', 'Report downloaded successfully!');
    }, 1000);
}

function shareReport(reportId) {
    if (navigator.share) {
        navigator.share({
            title: 'Intelligence Report',
            text: `Check out this intelligence report: ${reportId}`,
            url: `/reports/${reportId}`
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(`${window.location.origin}/reports/${reportId}`);
        showAlert('success', 'Report link copied to clipboard!');
    }
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        showAlert('warning', `Report ${reportId} deleted.`);
        // Remove row from table
        event.target.closest('tr').remove();
    }
}

function exportReports(format) {
    showAlert('info', `Exporting reports in ${format.toUpperCase()} format...`);
    // Simulate export
    setTimeout(() => {
        showAlert('success', `Reports exported successfully as ${format.toUpperCase()}!`);
    }, 2000);
}

// Alert helper function
function showAlert(type, message) {
    const alertsContainer = document.getElementById('alertsContainer');
    if (!alertsContainer) return;
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertsContainer.appendChild(alert);
    
    setTimeout(() => alert.remove(), 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    console.log('Reports page initialized');
});
</script>
{% endblock %}