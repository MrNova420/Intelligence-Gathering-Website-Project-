{% extends "base.html" %}
{% block title %}New Scan - Intelligence Platform{% endblock %}

{% block content %}
<div class="row animate-slide-up">
    <div class="col-md-8 mx-auto">
        <div class="text-center mb-5 animate-fade-scale" style="animation-delay: 0.1s;">
            <h1 class="text-gradient mb-3">
                <i class="fas fa-search me-3" style="color: var(--blue-500);"></i>
                Start New Intelligence Scan
            </h1>
            <p class="text-muted">Gather comprehensive intelligence with our advanced scanning capabilities</p>
        </div>
        
        <div class="card hover-lift animate-slide-up" style="animation-delay: 0.2s;">
            <div class="card-body p-4">
                <form id="scanForm" method="POST" action="/api/v1/scan">
                    <!-- Scan Type and Target Row -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <label for="scanType" class="form-label fw-semibold text-slate-200">
                                <i class="fas fa-cog me-2 text-blue-400"></i>Scan Type
                            </label>
                            <select class="form-select form-control hover-lift" id="scanType" name="scan_type" required data-tooltip="Choose the type of intelligence scan to perform">
                                <option value="">Select scan type...</option>
                                <option value="email" {% if scan_type == 'email' %}selected{% endif %}>
                                    üìß Email Intelligence
                                </option>
                                <option value="phone" {% if scan_type == 'phone' %}selected{% endif %}>
                                    üì± Phone Lookup
                                </option>
                                <option value="social" {% if scan_type == 'social' %}selected{% endif %}>
                                    üë• Social Media
                                </option>
                                <option value="domain" {% if scan_type == 'domain' %}selected{% endif %}>
                                    üåê Domain Analysis
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="target" class="form-label fw-semibold text-slate-200">
                                <i class="fas fa-bullseye me-2 text-green-400"></i>Target
                            </label>
                            <input type="text" class="form-control hover-lift" id="target" name="target" 
                                   placeholder="Enter email, phone, username, or domain..." required
                                   data-tooltip="Enter the target you want to investigate">
                        </div>
                    </div>
                    
                    <!-- Enhanced Scan Options -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold text-slate-200 mb-3">
                            <i class="fas fa-sliders-h me-2 text-purple-400"></i>Scan Options
                        </label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check p-3 rounded hover-lift" style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); transition: all 0.3s ease;">
                                    <input class="form-check-input" type="checkbox" id="deepScan" name="deep_scan" 
                                           style="transform: scale(1.2);">
                                    <label class="form-check-label fw-semibold text-slate-200" for="deepScan">
                                        <i class="fas fa-microscope me-2 text-blue-400"></i>Deep Scan
                                        <br><small class="text-muted">More comprehensive but slower analysis</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check p-3 rounded hover-lift" style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.1); transition: all 0.3s ease;">
                                    <input class="form-check-input" type="checkbox" id="includeSocial" name="include_social" checked 
                                           style="transform: scale(1.2);">
                                    <label class="form-check-label fw-semibold text-slate-200" for="includeSocial">
                                        <i class="fas fa-users me-2 text-green-400"></i>Social Media
                                        <br><small class="text-muted">Include social media profiles</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check p-3 rounded hover-lift" style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.1); transition: all 0.3s ease;">
                                    <input class="form-check-input" type="checkbox" id="includeHistorical" name="include_historical" 
                                           style="transform: scale(1.2);">
                                    <label class="form-check-label fw-semibold text-slate-200" for="includeHistorical">
                                        <i class="fas fa-history me-2 text-purple-400"></i>Historical Data
                                        <br><small class="text-muted">Search historical records and archives</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check p-3 rounded hover-lift" style="background: rgba(6, 182, 212, 0.05); border: 1px solid rgba(6, 182, 212, 0.1); transition: all 0.3s ease;">
                                    <input class="form-check-input" type="checkbox" id="realTimeMonitoring" name="real_time_monitoring" 
                                           style="transform: scale(1.2);">
                                    <label class="form-check-label fw-semibold text-slate-200" for="realTimeMonitoring">
                                        <i class="fas fa-satellite-dish me-2 text-cyan-400"></i>Real-time Monitoring
                                        <br><small class="text-muted">Monitor target for ongoing activity</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Priority and Schedule -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="priority" class="form-label fw-semibold text-slate-200">
                                <i class="fas fa-flag me-2 text-yellow-400"></i>Priority
                            </label>
                            <select class="form-select form-control hover-lift" id="priority" name="priority">
                                <option value="normal">üü¢ Normal</option>
                                <option value="high">üü† High</option>
                                <option value="urgent">üî¥ Urgent</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="schedule" class="form-label fw-semibold text-slate-200">
                                <i class="fas fa-clock me-2 text-amber-400"></i>Schedule
                            </label>
                            <select class="form-select form-control hover-lift" id="schedule" name="schedule">
                                <option value="immediate">‚ö° Start Immediately</option>
                                <option value="low_priority">‚è∞ Low Priority Queue</option>
                                <option value="scheduled">üìÖ Schedule for Later</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Enhanced Action Buttons -->
                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-primary btn-lg hover-lift" 
                                style="background: var(--gradient-primary); border: none; padding: 16px; font-weight: 600;">
                            <i class="fas fa-search me-2"></i>Start Intelligence Scan
                            <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="scanSpinner"></div>
                        </button>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary hover-lift" onclick="saveDraft()">
                                <i class="fas fa-save me-2"></i>Save as Draft
                            </button>
                            <button type="button" class="btn btn-outline-info hover-lift" onclick="loadTemplate()">
                                <i class="fas fa-template me-2"></i>Load Template
                            </button>
                            <button type="button" class="btn btn-outline-warning hover-lift" onclick="previewScan()">
                                <i class="fas fa-eye me-2"></i>Preview Scan
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modern Progress Indicator (Hidden by default) -->
        <div id="scanProgress" class="card hover-lift mt-4 d-none animate-slide-up">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="spinner-border text-primary me-3" role="status"></div>
                    <div>
                        <h6 class="mb-1 text-gradient">Scan in Progress</h6>
                        <small class="text-muted">Gathering intelligence data...</small>
                    </div>
                </div>
                <div class="progress mb-2" style="height: 8px; border-radius: 4px; background: rgba(148, 163, 184, 0.1);">
                    <div class="progress-bar" style="background: var(--gradient-primary); width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <div class="d-flex justify-content-between text-sm text-muted">
                    <span id="progressStatus">Initializing scan...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>
        
        <!-- Scan Templates (Quick Actions) -->
        <div class="row mt-5 animate-slide-up" style="animation-delay: 0.4s;">
            <div class="col-12">
                <h5 class="text-gradient mb-3">
                    <i class="fas fa-rocket me-2"></i>Quick Scan Templates
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card hover-lift h-100" style="cursor: pointer;" onclick="useTemplate('email-basic')">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-envelope fa-2x text-blue-400 mb-2"></i>
                                <h6 class="text-slate-200">Email Basic</h6>
                                <small class="text-muted">Standard email investigation</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card hover-lift h-100" style="cursor: pointer;" onclick="useTemplate('phone-comprehensive')">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-phone fa-2x text-green-400 mb-2"></i>
                                <h6 class="text-slate-200">Phone Comprehensive</h6>
                                <small class="text-muted">Complete phone number analysis</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card hover-lift h-100" style="cursor: pointer;" onclick="useTemplate('social-deep')">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-users fa-2x text-purple-400 mb-2"></i>
                                <h6 class="text-slate-200">Social Deep Dive</h6>
                                <small class="text-muted">Comprehensive social media analysis</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card hover-lift h-100" style="cursor: pointer;" onclick="useTemplate('domain-security')">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-shield-alt fa-2x text-cyan-400 mb-2"></i>
                                <h6 class="text-slate-200">Security Audit</h6>
                                <small class="text-muted">Domain security assessment</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Scan JavaScript -->
<script>
// Modern Scan Management System
class ModernScanManager {
    constructor() {
        this.form = document.getElementById('scanForm');
        this.progressContainer = document.getElementById('scanProgress');
        this.templates = {
            'email-basic': {
                scanType: 'email',
                deepScan: false,
                includeSocial: true,
                includeHistorical: false,
                realTimeMonitoring: false,
                priority: 'normal'
            },
            'phone-comprehensive': {
                scanType: 'phone',
                deepScan: true,
                includeSocial: true,
                includeHistorical: true,
                realTimeMonitoring: false,
                priority: 'high'
            },
            'social-deep': {
                scanType: 'social',
                deepScan: true,
                includeSocial: true,
                includeHistorical: true,
                realTimeMonitoring: true,
                priority: 'normal'
            },
            'domain-security': {
                scanType: 'domain',
                deepScan: true,
                includeSocial: false,
                includeHistorical: true,
                realTimeMonitoring: true,
                priority: 'high'
            }
        };
        this.init();
    }

    init() {
        this.setupFormHandlers();
        this.setupRealTimeValidation();
        this.setupAnimations();
    }

    setupFormHandlers() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.startScan();
        });

        // Enhanced form validation with real-time feedback
        const inputs = this.form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', () => this.validateField(input));
            input.addEventListener('focus', (e) => this.highlightField(e.target, true));
            input.addEventListener('blur', (e) => this.highlightField(e.target, false));
        });
    }

    setupRealTimeValidation() {
        const targetInput = document.getElementById('target');
        const scanTypeSelect = document.getElementById('scanType');

        targetInput.addEventListener('input', () => {
            this.validateTarget(targetInput.value, scanTypeSelect.value);
        });

        scanTypeSelect.addEventListener('change', () => {
            this.updateTargetPlaceholder(scanTypeSelect.value);
            this.validateTarget(targetInput.value, scanTypeSelect.value);
        });
    }

    validateField(field) {
        const isValid = field.checkValidity();
        
        field.style.borderColor = isValid ? 'var(--green-500)' : 'var(--red-500)';
        field.style.boxShadow = isValid ? 
            '0 0 0 3px rgba(16, 185, 129, 0.1)' : 
            '0 0 0 3px rgba(239, 68, 68, 0.1)';

        // Add checkmark or error icon
        const existingIcon = field.parentNode.querySelector('.validation-icon');
        if (existingIcon) existingIcon.remove();

        const icon = document.createElement('i');
        icon.className = `fas ${isValid ? 'fa-check text-green-400' : 'fa-times text-red-400'} validation-icon`;
        icon.style.cssText = 'position: absolute; right: 12px; top: 50%; transform: translateY(-50%); z-index: 10;';
        
        if (field.parentNode.style.position !== 'relative') {
            field.parentNode.style.position = 'relative';
        }
        field.parentNode.appendChild(icon);

        return isValid;
    }

    highlightField(field, focused) {
        if (focused) {
            field.style.transform = 'translateY(-2px)';
            field.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.2)';
        } else {
            field.style.transform = '';
            if (!field.checkValidity()) {
                field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                field.style.boxShadow = '';
            }
        }
    }

    validateTarget(target, scanType) {
        if (!target || !scanType) return false;

        const patterns = {
            email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            phone: /^[\+]?[1-9][\d]{0,15}$/,
            domain: /^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/,
            social: /^[a-zA-Z0-9._-]+$/
        };

        const isValid = patterns[scanType] ? patterns[scanType].test(target) : target.length > 0;
        
        const targetField = document.getElementById('target');
        this.validateField(targetField);
        
        return isValid;
    }

    updateTargetPlaceholder(scanType) {
        const placeholders = {
            email: 'Enter email address (e.g., user@example.com)',
            phone: 'Enter phone number (e.g., +1234567890)',
            domain: 'Enter domain name (e.g., example.com)',
            social: 'Enter username or handle (e.g., @username)'
        };

        document.getElementById('target').placeholder = placeholders[scanType] || 'Enter target to investigate';
    }

    async startScan() {
        const formData = new FormData(this.form);
        const data = Object.fromEntries(formData.entries());

        // Show loading state
        this.showLoadingState();

        // Show progress container
        this.progressContainer.classList.remove('d-none');

        try {
            // Simulate scan progress
            await this.simulateScanProgress();

            // Submit to backend
            const response = await fetch('/api/v1/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                this.showScanSuccess(result);
            } else {
                this.showScanError(result.message);
            }

        } catch (error) {
            console.error('Scan error:', error);
            this.showScanError('Failed to start scan. Please try again.');
        }
    }

    showLoadingState() {
        const submitBtn = this.form.querySelector('button[type="submit"]');
        const spinner = document.getElementById('scanSpinner');
        
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        
        // Add pulsing effect
        submitBtn.style.animation = 'pulse 2s infinite';
    }

    async simulateScanProgress() {
        const progressBar = this.progressContainer.querySelector('.progress-bar');
        const statusElement = document.getElementById('progressStatus');
        const percentElement = document.getElementById('progressPercent');

        const steps = [
            { percent: 10, status: 'Initializing scan modules...' },
            { percent: 25, status: 'Validating target...' },
            { percent: 40, status: 'Gathering OSINT data...' },
            { percent: 60, status: 'Analyzing social media presence...' },
            { percent: 80, status: 'Cross-referencing databases...' },
            { percent: 95, status: 'Compiling results...' },
            { percent: 100, status: 'Scan completed successfully!' }
        ];

        for (const step of steps) {
            await new Promise(resolve => setTimeout(resolve, 800));
            
            progressBar.style.width = `${step.percent}%`;
            statusElement.textContent = step.status;
            percentElement.textContent = `${step.percent}%`;

            // Add visual feedback
            if (step.percent === 100) {
                progressBar.style.background = 'var(--gradient-success)';
                statusElement.style.color = 'var(--green-400)';
            }
        }
    }

    showScanSuccess(result) {
        if (window.modernPlatform) {
            window.modernPlatform.notifications.show('Scan completed successfully!', 'success');
        }

        // Redirect to results page
        setTimeout(() => {
            window.location.href = `/scan/${result.scan_id}`;
        }, 2000);
    }

    showScanError(message) {
        if (window.modernPlatform) {
            window.modernPlatform.notifications.show(message, 'error');
        }

        // Reset form
        this.resetForm();
    }

    resetForm() {
        const submitBtn = this.form.querySelector('button[type="submit"]');
        const spinner = document.getElementById('scanSpinner');
        
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
        submitBtn.style.animation = '';
        
        this.progressContainer.classList.add('d-none');
    }

    setupAnimations() {
        // Add hover animations to form elements
        const formGroups = document.querySelectorAll('.form-check');
        formGroups.forEach(group => {
            group.addEventListener('mouseenter', () => {
                group.style.transform = 'scale(1.02)';
                group.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            });
            
            group.addEventListener('mouseleave', () => {
                group.style.transform = '';
                group.style.boxShadow = '';
            });
        });
    }
}

// Template and utility functions
window.useTemplate = function(templateId) {
    const scanManager = window.scanManager;
    const template = scanManager.templates[templateId];
    
    if (!template) return;

    // Fill form with template data
    document.getElementById('scanType').value = template.scanType;
    document.getElementById('deepScan').checked = template.deepScan;
    document.getElementById('includeSocial').checked = template.includeSocial;
    document.getElementById('includeHistorical').checked = template.includeHistorical;
    document.getElementById('realTimeMonitoring').checked = template.realTimeMonitoring;
    document.getElementById('priority').value = template.priority;

    // Update placeholder
    scanManager.updateTargetPlaceholder(template.scanType);

    // Show notification
    if (window.modernPlatform) {
        window.modernPlatform.notifications.show(`Template "${templateId}" loaded successfully!`, 'info');
    }

    // Animate template selection
    const templateCards = document.querySelectorAll('.card[onclick*="' + templateId + '"]');
    templateCards.forEach(card => {
        card.style.background = 'var(--gradient-primary)';
        card.style.transform = 'scale(1.05)';
        
        setTimeout(() => {
            card.style.background = '';
            card.style.transform = '';
        }, 1000);
    });
};

window.saveDraft = function() {
    const formData = new FormData(document.getElementById('scanForm'));
    const data = Object.fromEntries(formData.entries());
    
    localStorage.setItem('scanDraft', JSON.stringify(data));
    
    if (window.modernPlatform) {
        window.modernPlatform.notifications.show('Scan configuration saved as draft', 'success');
    }
};

window.loadTemplate = function() {
    const draft = localStorage.getItem('scanDraft');
    if (!draft) {
        if (window.modernPlatform) {
            window.modernPlatform.notifications.show('No saved draft found', 'info');
        }
        return;
    }

    const data = JSON.parse(draft);
    
    // Fill form with draft data
    Object.entries(data).forEach(([key, value]) => {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.type === 'checkbox') {
                field.checked = value === 'on';
            } else {
                field.value = value;
            }
        }
    });

    if (window.modernPlatform) {
        window.modernPlatform.notifications.show('Draft loaded successfully!', 'success');
    }
};

window.previewScan = function() {
    const formData = new FormData(document.getElementById('scanForm'));
    const data = Object.fromEntries(formData.entries());
    
    // Create preview modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;

    const previewContent = Object.entries(data).map(([key, value]) => {
        if (typeof value === 'string' && value) {
            return `<div class="mb-2"><strong>${key.replace('_', ' ').toUpperCase()}:</strong> ${value}</div>`;
        }
        return '';
    }).join('');

    modal.innerHTML = `
        <div style="
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
        ">
            <h3 style="color: var(--slate-100); margin-bottom: 20px; text-align: center;">
                <i class="fas fa-eye me-2"></i>Scan Preview
            </h3>
            <div style="color: var(--slate-300); margin-bottom: 20px;">
                ${previewContent || '<p>No scan data to preview</p>'}
            </div>
            <div style="text-align: center;">
                <button onclick="this.closest('.modal').remove()" style="
                    background: var(--gradient-primary);
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                ">Close Preview</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    
    // Auto-close after 10 seconds
    setTimeout(() => {
        if (modal.parentNode) modal.remove();
    }, 10000);
};

// Initialize scan manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.scanManager = new ModernScanManager();
    
    // Load draft if available
    const draft = localStorage.getItem('scanDraft');
    if (draft && window.modernPlatform) {
        window.modernPlatform.notifications.show('Previous draft available - click "Load Template" to restore', 'info', 5000);
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .validation-icon {
        transition: all 0.3s ease;
    }
    
    .form-check:hover {
        transform: translateY(-2px);
    }
    
    .template-card-selected {
        background: var(--gradient-primary) !important;
        transform: scale(1.05);
        transition: all 0.3s ease;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}